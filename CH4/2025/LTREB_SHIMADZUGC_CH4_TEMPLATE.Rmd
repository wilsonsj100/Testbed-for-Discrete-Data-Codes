---
title: "LTREB_SHIMADZUGC_CH4_TEMPLATE"
author: "Brenden Blakley"
date: "2025-08-22"
output: pdf_document
---

##Set Up

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(stringr)
library(fuzzyjoin)

```

```{r run information, include=TRUE}
cat("Run Information: Brenden D. Blakley ") #lets you know what section you're in 
#set the run date & user name 
  run_date <- "06/23/2025"
  sample_year <- "2025"
  sample_month <- "May"
  user <- "Brenden Blakley"

#identify the files you want to read in 
  #read in as a list to accommodate multiple runs in a month

GHG_file <- "Raw Data/20250623_2M_MAY_GHG.csv"


# Define the file path for QAQC log file - NO Need to change just check year 
log_path <- "Processed Data/LTREB_2M_ShimadzuGC_QAQC_2025.csv"

# Define final path for data be sure to change year and month and run number
final_path <- "Processed Data/GCReW_CO2xN_Porewater_CH4_202505_4.csv"
#Gas in Water Calculations
  # "TempC" column value in Kelvin (equilibration temperature) and volume of gas (in liters) in syringe
TempC = 22.7
volume = 0.012

#record any notes about the run or anything other info here: 
  run_notes <- ""
  
#Set up file path for metadata 
  #downloaded metadata csv - downloaded from Google drive as csv for this year
  Raw_Metadata = "Raw Data/Sample_IDs_LTREB_SMARTX_2024.csv"
  #Collection_Dates = "Raw Data/Sample_Collection_Dates_2024.csv"

  cat(run_notes)
```
##Read in metadata and create similar sample IDs for matching to samples 
```{r pull in metadata for later, include=FALSE}

raw_metadata <- read.csv(Raw_Metadata)
#clean up columns in metadata file:
  #Pull out only SMARTX Rows 
  #Create a Sample_Name column to match the SEAL
metadata <- raw_metadata %>%
  filter(grepl("CO2xN", Experiment, ignore.case = TRUE)) %>%
  mutate(Sample_Name = paste0(Sample.ID)) %>%
  mutate(Month = sample_month) %>%
  mutate(Year = sample_year) %>%
    rename(
    Sample_ID = Sample.ID,
    Plot_Name = Chamber.Plot.Name, 
    CO2_Treatment = CO2.Treatment, 
    N_Treatment = N.Treatment,
    Temp_Treatment = Temp.Treatment
  ) %>%
  select(-Temp_Treatment) %>%
     mutate(Treatment = ifelse(
    CO2_Treatment == "Elev" &
      N_Treatment == "N",
    "eCO2_N",
    ifelse(
      CO2_Treatment == "Elev" &
        N_Treatment == "Amb",
      "eCO2",
      ifelse(CO2_Treatment == "Amb" &
               N_Treatment == "N"  , "N" , "Control")
    )
  ))

#Bring in the collection date and any field notes if relevant 
#collection_metadata <- read.csv(Collection_Dates)
  #then we will merge the collection date for SMARTX based on the project and the chambers 

```

## Read in data files
```{r , echo=FALSE}

#Read in Nov Data 
raw <- read.csv(GHG_file)

#rename column
colnames(raw)[1] <- "Sample_ID"
  
#head(stds_ch4) 

```

## Assess standard curves
```{r , echo=FALSE}

stds_ch4 <-  raw %>%  
  filter(str_detect(Type, "Standard"))

#Correct data class
stds_ch4[,"Conc_CH4"] <- as.numeric(stds_ch4[,"Conc_CH4"])

#Curve for CH4
CH4_Curve <- ggplot(stds_ch4, aes(Conc_CH4, CH4_Area)) + geom_point(size=4) + 
  geom_smooth(method = "lm", se = FALSE) + labs(title="CH4 Std Curve")
CH4_Curve

CH4_lm <- lm(stds_ch4$CH4_Area ~ stds_ch4$Conc_CH4)
summary(CH4_lm)
cf <- coef(CH4_lm)

#create data frame with 1 rows and 0 columns
Slope_CH4 <- data.frame(matrix(ncol = 0, nrow = 1))
Slope_CH4$Curve <- "Slope_CH4"
Slope_CH4$R2 <- summary(CH4_lm)$adj.r.squared
Slope_CH4$Slope <- cf[2]
Slope_CH4$Intercept <- cf[1]
#head(Slope_CH4_low)

#add in run date
Slope_CH4$Run_Date <- run_date

log <- read.csv(log_path)
head(log)
log <- log[ ,-c(1)]
log <- rbind(log, Slope_CH4)

Slopes_chk <- ggplot(log, aes(Run_Date, Slope, col=Curve)) + geom_point(size=4) + geom_line() + theme_bw()
Slopes_chk

write.csv(log, log_path)
```

## Now calculate the CH4 & CO2 concentrations in ppm  
```{r}
#head(raw)

#pull out methane standards
Samples <-  raw %>%  
  filter(!str_detect(Type, "Lab air")) %>%  
  filter(!str_detect(Type, "Standard")) %>%  
  filter(!str_detect(Type, "Blank")) %>%  
  filter(!str_detect(Type, "Chk_STD")) %>%  
   filter(!str_detect(Type, "ChkStd")) %>%
  filter(!str_detect(Type, "NA"))
#head(Samples)

#Calculate CH4 concentrations in ppm
Samples$CH4_Conc_ppm <- (Samples$CH4_Area-Slope_CH4$Intercept)/Slope_CH4$Slope

#head(Samples)

##########make flags for any dilutions needed 
#highest CH4 standard = 20000
#highest CO2 standard = 50000

Samples$CH4_Flag <- ifelse(Samples$CH4_Conc_ppm >20000, "Needs Dilution", "Within Range")

#head(Samples)

```

## Check the Check Standards 
```{r, echo=FALSE}

chks <-  raw %>%  
 filter(!str_detect(Type, "Lab air")) %>%  
  filter(!str_detect(Type, "Standard")) %>%  
  filter(!str_detect(Type, "Blank")) %>%  
   filter(!str_detect(Type, "Sample")) %>%
  filter(!str_detect(Type, "NA"))
#head(chks)

#Calculate CH4 concentrations in ppm
chks$CH4_Conc_ppm <-
                      (chks$CH4_Area-Slope_CH4$Intercept)/Slope_CH4$Slope

#change this if check standard concentrations are different 
level_ch4 <- 1000      #ppm

#calculate percent difference of check standards 
chks$Ch4_diff <- ((chks$CH4_Conc_ppm - level_ch4)/((chks$CH4_Conc_ppm + level_ch4)/2)) * 100
chks$CH4_diff_flag <-  ifelse(chks$Ch4_diff <10, 'YES', 'NO, rerun')

#now plot the Ch4 concentrations and the CO2 concentrations vs. the expected concentration 
#then also make the color the percent difference between the expected and observed concentration 

ch4_chk <-  ggplot(data = chks, aes(x = Sample_ID, y = CH4_Conc_ppm, fill=CH4_diff_flag)) +
       geom_bar(stat = 'identity') + 
        scale_fill_manual(values=c( "NO, rerun" = "darkgrey", "YES" = "darkgreen"))+
        theme_classic() + labs(x= " ", y="Concentration (ppm)", title="Check Stds: CH4") + 
        theme(legend.position="bottom") +  geom_hline(yintercept=level_ch4, linetype="dashed", 
                color = "black", size=1) +
  guides(fill=guide_legend(title="% Difference <10%"))


ch4_chk


```
##Check the Blanks
```{r}
Blanks <-  raw %>%  
  filter(!str_detect(Type, "Lab air")) %>%  
  filter(!str_detect(Type, "Standard")) %>%  
  filter(!str_detect(Type, "Sample")) %>%  
  filter(!str_detect(Type, "Chk_STD")) %>%  
   filter(!str_detect(Type, "ChkStd")) %>%
  filter(!str_detect(Type, "NA"))

#Calculate CH4 concentrations in ppm
Blanks$CH4_Conc_ppm <-
                      (Blanks$CH4_Area-Slope_CH4$Intercept)/Slope_CH4$Slope 

RSV_Blanks_CH4 <- abs((sd(Blanks$Conc_CH4_ppm)/mean(Blanks$Conc_CH4_ppm))*100)
```


## Dilution correct samples 
```{r}

#multiply the concentration by the dilution factor
Samples$CH4_Conc_ppm_dilcorr <- (Samples$CH4_Conc_ppm * 12 + Samples$Sample_Volume )/(Samples$Sample_Volume)

#check results
#head(Samples)

#quick first look at the samples 
ch4_samples <-  ggplot(data = Samples, aes(x = Sample_ID, y = CH4_Conc_ppm, fill=CH4_Flag)) +
       geom_bar(stat = 'identity') + 
        scale_fill_manual(values=c("darkgreen","red"))+
        theme_classic() + labs(x= " ", y="CH4 (ppm)", title="CH4: Green = Within Range") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        theme(legend.position="none") 

ch4_samples


```


## If samples are water calculate gas in water  
```{r, echo=FALSE}

# Convert ppm CH4 to total umol CH4 in the sample headspace
# use Ideal Gas Law:  
#   hdsp umol CH4 = ppm CH4*(PV/RT) 
#      P = 1 (pressure in atm)
#      R = 0.082 (gas constant)
#      V = 0.012 (gas syringe volume in L)
#      T = "TempC" column value in Kelvin (equilibration temperature)

#Calculate CH4 concentrations in ppm
Samples$CH4_Conc_umol <- (Samples$CH4_Conc_ppm_dilcorr*((1*volume/1000)/(0.08206*(TempC+273.15))))/(volume/1000)
                  

#quick first look at the samples 
ch4_samples1 <-  ggplot(data = Samples, aes(x = Sample_ID, y = CH4_Conc_umol)) +
  geom_bar(stat = 'identity') +
  theme_classic() +
  labs(x = " ", y = "CH4 (uM)", title = "CH4 Gas in Water") +
  theme(axis.text.x = element_text(
    angle = 90,
    vjust = 0.5,
    hjust = 1
  )) +
  theme(legend.position = "none") 


ch4_samples1

```

## Merge samples with Metadata & check all samples are present 
```{r check sample ids with metadata, echo=FALSE}

cat("Merge Samples with Metadata")

#check to see if all samples are present in the metadata 
all_present <- all(metadata$Sample_Name %in% Samples$Sample_ID)

if (all_present) {
  message("All sample IDs are present in data")
} else {
  message("Some sample IDs are missing from data.")
  
  # Optional: Which ones are missing?
  missing_ids <- setdiff(metadata$Sample_Name, Samples$Sample_ID)
  print(missing_ids)
}


#merge metadata with sample run data 
merged_data <- metadata %>%
  mutate(Sample_ID = paste0("\\b", Sample_ID, "\\b")) %>%
  fuzzyjoin::regex_left_join(Samples, ., by = c(Sample_ID = "Sample_Name"))

#might want to include a flag or something to see that all the samples are included? 

df_all_clean <- merged_data 

```

## Visualize Data
```{r Visualize Data, echo=FALSE}
cat("Visualize Data")

### Ammonia 
CH4_forplot <- df_all_clean

#need to work out how best to plot these data 

viz_CH4_plot <- ggplot(data = CH4_forplot, aes(x = as.factor(Treatment), y = CH4_Conc_umol, fill = as.factor(Treatment))) +
       geom_bar(stat = "identity", position = position_dodge2(preserve = "single"), 
                 color="black") + 
       facet_grid(~ Depth, scales="free_x") +
  scale_fill_manual(values = c("Control" = "blue", 
                                     "eCO2" = "red", 
                                     "N" = "yellow",
                                     "eCO2_N" = "orange")) +
        theme_classic() + 
        labs(x= " ", y="CH4 (umol)", title="2M: Porewater CH4", fill = "Treatment") + 
          theme(legend.position = "right") +
          scale_x_discrete(drop = TRUE)+
        theme(axis.text.x = element_text(angle = 90, vjust = 0.3), 
              panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8))
print(viz_CH4_plot) 


```

## Write out processed data & slopes  
```{r}
#check results
#head(Samples)

#pull out what we need 
Samples1 <- df_all_clean[ ,c(7, 9:14, 16:23 )]
#head(Samples1)

write.csv(Samples1, final_path)

```


#end
